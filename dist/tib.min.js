function murmurhash3_32_gc(a,b){var c,d,e,f,g,h,i,j;for(c=3&a.length,d=a.length-c,e=b,g=3432918353,h=461845907,j=0;d>j;)i=255&a.charCodeAt(j)|(255&a.charCodeAt(++j))<<8|(255&a.charCodeAt(++j))<<16|(255&a.charCodeAt(++j))<<24,++j,i=(65535&i)*g+(((i>>>16)*g&65535)<<16)&4294967295,i=i<<15|i>>>17,i=(65535&i)*h+(((i>>>16)*h&65535)<<16)&4294967295,e^=i,e=e<<13|e>>>19,f=5*(65535&e)+((5*(e>>>16)&65535)<<16)&4294967295,e=(65535&f)+27492+(((f>>>16)+58964&65535)<<16);switch(i=0,c){case 3:i^=(255&a.charCodeAt(j+2))<<16;case 2:i^=(255&a.charCodeAt(j+1))<<8;case 1:i^=255&a.charCodeAt(j),i=(65535&i)*g+(((i>>>16)*g&65535)<<16)&4294967295,i=i<<15|i>>>17,i=(65535&i)*h+(((i>>>16)*h&65535)<<16)&4294967295,e^=i}return e^=a.length,e^=e>>>16,e=2246822507*(65535&e)+((2246822507*(e>>>16)&65535)<<16)&4294967295,e^=e>>>13,e=3266489909*(65535&e)+((3266489909*(e>>>16)&65535)<<16)&4294967295,e^=e>>>16,e>>>0}var TIBIT=function(a){var b=function(b,c){a.CONSOLE_OUTPUT&&console.log("running loadElementParams for following params obj & following element: \n \t",b,"\n \t",c);for(var d in b)c.getAttribute("data-bd-"+d)&&(b[d]=c.getAttribute("data-bd-"+d));return a.CONSOLE_OUTPUT&&console.log("finished loadElementParams, outputting following params obj: \n \t",b),b},c=function(){for(var b in localStorage)if(b.substr(0,a.CONSTANTS.SUBREF_PREFIX.length)===a.CONSTANTS.SUBREF_PREFIX){var c=JSON.parse(localStorage.getItem(b)),d=new Date(c.EXP).getTime();Date.now()>d&&(a.CONSOLE_OUTPUT&&console.log("Removing localstorage item "+b),localStorage.removeItem(b))}},d=function(b,c){if("undefined"!=typeof b){for(var d in c)b.hasOwnProperty(d)&&(c[d]=b[d]);a.CONSOLE_OUTPUT&&console.log("mapParams mapped following source to following target obj: \n \t",b,"\n \t",c)}},e=function(b,c){var d={};if("object"==typeof b){for(var e in b)b.hasOwnProperty(e)&&(d[e]=b[e]);return a.CONSOLE_OUTPUT&&console.log("cloneObj mapped following source to following output obj: \n \t",b,"\n \t",d),d}return!1},f=function(b,c){switch(a.CONSOLE_OUTPUT&&console.log("Running base tibit.init() function"),d(b,a.initiatorDefaultParams),d(c,a.buttonDefaultParams),document.readyState){case"loading":a.CONSOLE_OUTPUT&&console.log("Document is still loading - setting event listener"),document.addEventListener("DOMContentLoaded",a.initTibElements);break;case"loaded":case"interactive":case"complete":a.CONSOLE_OUTPUT&&console.log("Document loaded - attempting to create tib elements"),document.getElementsByClassName("bd-tib-btn")&&a.initTibElements()}};a.CONSOLE_OUTPUT=a.CONSOLE_OUTPUT||!1;var g={SUBREF_PREFIX:"bd-subref-",QTY_CACHE_DURATION:20,BUTTON_CLASS:"bd-tib-btn",BUTTON_STYLE_CLASS:"bd-dynamic"};return a.CONSOLE_OUTPUT&&console.log("TIBIT.constants saved: \n \t",g),a.init=f,a.cloneObj=e,a.CONSTANTS=g,a.loadElementParams=b,c(),a.CONSOLE_OUTPUT&&console.log("successfully loaded base module"),a}(TIBIT||{}),TIBIT=function(a){var b=function(b){a.CONSOLE_OUTPUT&&console.log("Generating TibButton for domElement \n \t",b);var d=function(){var a=l.BTN||"default",b=l.BTS||"https://widget.tibit.com/buttons/",c=new XMLHttpRequest;c.open("GET",b+"tib-btn-"+a+".html",!0),c.responseType="document",c.onreadystatechange=function(){4===c.readyState&&200===c.status&&c.responseXML&&e(c.responseXML)},c.send()},e=function(b){a.CONSOLE_OUTPUT&&console.log("Button XML retrieved successfully - attempting to write button");var c=b.getElementById("tib-btn-"+l.BTN);if(!c)throw"bd: failed to find tib-btn-"+l.BTN+" in received XML";var d=document.importNode(c,!0);0===j.children.length?j.appendChild(d):j.replaceChild(d,j.children[0]),j.children[0].removeAttribute("id"),h(b,l),f(),g(),j.classList.contains("bd-tib-btn")||j.classList.add("bd-tib-btn"),i.counterElement=i.getCounterElement(),i.counterElement&&i.writeCounter(k.updateQty())},f=function(){a.CONSOLE_OUTPUT&&console.log("Setting button colour to "+l.BTC);var b=j.getElementsByClassName("bd-btn-backdrop")[0];b&&l.BTC&&""!==l.BTC&&(b.style.fill=l.BTC)},g=function(){a.CONSOLE_OUTPUT&&console.log("Setting button height to "+l.BTH),l.BTH&&""!==l.BTH&&(j.style.height=l.BTH+"px");var b=j.children[0];""===b.style.width&&(b.style.width=(b.getBBox().width*(b.parentNode.clientHeight/b.getBBox().height)).toString()+"px")},h=function(a,b){var c=document.getElementsByTagName("head")[0],d=document.getElementById("bd-css-tib-btn");if(!d){var e=document.createElement("link");e.id="bd-css-tib-btn",e.rel="stylesheet",e.type="text/css",e.href="https://widget.tibit.com/assets/css/tib.css",d=c.appendChild(e)}if(!document.getElementById("tib-btn-"+b.BTN+"-css")){var f=a.getElementById("tib-btn-"+b.BTN+"-css");f&&c.insertBefore(f,f.nextSibling)}},i=this.tibElement=b.tibElement,j=this.domElement=b,k=this.tibInitiator=b.tibInitiator,l=this.params=a.cloneObj(c);a.loadElementParams(this.params,b),this.domElement.classList.add("bd-tib-btn-"+this.params.BTN),d(this.params,this.domElement)},c={BTN:"default",BTH:"",BTC:"",BTS:""};return a.TibButton=b,a.buttonDefaultParams=c,a.CONSOLE_OUTPUT&&console.log("TIBIT: successfully loaded button module"),a}(TIBIT||{}),TIBIT=function(a){var b,c,d,e=1,f=function(a){c=a,c.initialHref=c.location.href,b=setInterval(function(){h()},100)},g=function(){a.CONSOLE_OUTPUT&&console.log("Running persistAck for storage  ");var b=a.CONSTANTS.SUBREF_PREFIX+d.obj.SUB+"-TIBBED",c=e*(i(d.obj.PAD)?3e5:864e5);a.CONSOLE_OUTPUT&&console.log('Duration calculated as "'+c+'"');var f=new Date(d.obj.ISS);a.CONSOLE_OUTPUT&&console.log("Retrieved issue date "+f);var g=new Date(f.getTime()+c);a.CONSOLE_OUTPUT&&console.log("Generated expire date "+g);var h={ISS:f,EXP:g};localStorage.setItem(b,JSON.stringify(h));var j=document.createEvent("customEvent");j.initCustomEvent("tibstate",!0,!1,b),window.dispatchEvent(j)},h=function(){j()&&(d=k(),m(c),l(d)&&g())},i=function(a){return a&&"mn2".search(a.substr(0,1))!==-1},j=function(){var a;try{if(c.closed)return clearInterval(b),!1;a=c.location.hostname}catch(a){if(a.code===a.SECURITY_ERR)return!1;throw clearInterval(b),a}return c.initialHref!==c.location.href&&0!==a.length&&("tib.me"!==a.substr(a.length-6)&&(clearInterval(b),!0))},k=function(){var a,b=c.location.search,e="[^?]*?(.*&)?tibtok=([^&]*)";return d=b.match(e)[2],d=decodeURIComponent(d),d=atob(d),a=JSON.parse(d),{json:d,obj:a}},l=function(){return d.timestamp=new Date(d.obj.SEN||d.obj.ISS),d.offset=Date.now()-d.timestamp.getTime(),!0},m=function(){var a="[^?]*?(.*&)?noclose($|[=&])";if(c.location.search.search(a)!==-1)return!1;try{c.close()}catch(a){console.error("attempt to automatically close callback window failed")}return!1};return a.initializeCallback=f,a.CONSOLE_OUTPUT&&console.log("successfully loaded callback module"),a}(TIBIT||{}),TIBIT=function(a){var b=[],c=a.CONSTANTS,d=function(){a.CONSOLE_OUTPUT&&console.log("Running initTibElements ");for(var b=document.getElementsByClassName(c.BUTTON_CLASS),d=0,f=b.length;d<f;d++){var g=new e(b[d]);a.tibElements.push(g)}a.CONSOLE_OUTPUT&&console.log("tibit.tibElements array populated: \n \t",a.tibElements)},e=function(b){a.CONSOLE_OUTPUT&&console.log("Generating TibElement for domElement \n \t",b),this.getCounterElement=function(){return g=b.getElementsByClassName("bd-btn-counter")[0]||null,g&&d.updateQty(),g},this.writeCounter=function(a){g&&!isNaN(a)&&""!==a&&null!==a&&a>=0&&(g.textContent=parseInt(a,10))};var c,d,e,f,g,h=function(){this.tibbed=!0,b.classList.add("tibbed")},i=function(){this.testnet=!0,b.classList.add("testnet")},j=function(a){"tibstate"===a.type&&(a.key=a.detail,a.newValue=localStorage[a.key]),a.newValue&&a.key===d.storageKey+"-QTY"&&this.writeCounter(JSON.parse(a.newValue).QTY),a.newValue&&a.key===d.storageKey+"-TIBBED"&&h(b)};c=b.tibElement=this,e=this.tibbed=!1,f=this.testnet=!1,this.domElement=b,d=b.tibInitiator=this.tibInitiator=new a.Initiator(b),b.classList.add(d.storageKey),b.addEventListener("click",d.dispatch.bind(d)),window.addEventListener("tibstate",j.bind(this)),window.addEventListener("storage",j.bind(this)),g=this.counterElement=this.getCounterElement(),g&&this.writeCounter(d.updateQty()),b.classList.contains("bd-dynamic")&&(b.tibButton=new a.TibButton(b)),d.isTestnet()&&i(),localStorage.getItem(d.storageKey+"-TIBBED")&&h(),"BUTTON"!==b.tagName||b.getAttribute("type")||b.setAttribute("type","button")};return a.TibElement=e,a.initTibElements=d,a.tibElements=b,a.CONSOLE_OUTPUT&&console.log("successfully loaded element module"),a}(TIBIT||{}),TIBIT=function(a){var b=function(b){this.dispatch=function(){var b="tibit",c="height=721,width=640,menubar=no,location=no,resizable=no,status=no",d=document.createElement("a");d.href="///",d.hostname="tib.me",d.protocol="https",d.search=g(this.params),d.search=d.search.substr(0,d.search.length-1);var e=window.open(d.href,b,c);return"none"!==this.params.CBK&&this.params.CBK===window.location.origin&&(a.CONSOLE_OUTPUT&&console.log("No CBK specified - initializing inline callback poller"),a.initializeCallback(e,this)),e},this.updateQty=function(b){a.CONSOLE_OUTPUT&&console.log('Running updateQTY for storageKey "'+i+'"');var c=this.params.QTY;if(c||(c=localStorage.getItem(i+"-QTY"),c&&(c=JSON.parse(localStorage.getItem(i+"-QTY")).QTY),a.CONSOLE_OUTPUT&&console.log("updateQty retrieved QTY "+c+" from localStorage")),c){var d=document.createEvent("CustomEvent");d.initCustomEvent("tibstate",!0,!1,i+"-QTY"),window.dispatchEvent(d)}else a.CONSOLE_OUTPUT&&console.log("subrefQTY not set ("+c+") - attempting to fetch"),e(),c=null;return c},this.isTestnet=function(a){return this.params.PAD&&"mn2".search(this.params.PAD.substr(0,1))!==-1};var e=function(){var a=new XMLHttpRequest,b="https://tib.me/getqty/"+g(h);a.open("GET",b,!0),a.send(),a.onreadystatechange=function(){4===a.readyState&&200===a.status&&f(this)}},f=function(b){var c={QTY:JSON.parse(b.response).QTY,EXP:new Date((new Date).getTime()+6e4*a.CONSTANTS.QTY_CACHE_DURATION)};localStorage.setItem(i+"-QTY",JSON.stringify(c));var d=document.createEvent("CustomEvent");d.initCustomEvent("tibstate",!0,!1,i+"-QTY"),window.dispatchEvent(d)},g=function(){var b="?";for(var c in h)if(h[c]){if("CBK"===c&&"none"===h[c])break;b+=c,b+="=",b+=encodeURIComponent(h[c]),b+="&"}return a.CONSOLE_OUTPUT&&console.log('Generated querystring "'+b+'"'),b.substr(0,b.length)},h=this.params=a.cloneObj(d);a.loadElementParams(h,b),this.params.TIB||(this.params.TIB=window.location.hostname+window.location.pathname+window.location.search),this.params.SUB||(this.params.SUB=c(this.params.TIB)),this.params.CBK||(this.params.CBK=window.location.origin);var i=this.storageKey=a.CONSTANTS.SUBREF_PREFIX+this.params.SUB},c=function(a){var b=a.replace(/^(https?:)?(\/\/)?(www.)?/g,"");return b=murmurhash3_32_gc(b,0),"TIB-SHA256-"+b},d={PAD:"",SUB:"",CBK:"",ASN:"",TIB:""};return a.initiatorDefaultParams=d,a.Initiator=b,a.CONSOLE_OUTPUT&&console.log("successfully loaded initiator module"),a}(TIBIT||{});